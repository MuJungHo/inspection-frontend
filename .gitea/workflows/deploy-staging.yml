name: 部署到測試環境

# 觸發條件：只有 staging 分支的 push 和 pull request 會觸發
on:
  push:
    branches:
      - staging
  # pull_request:
  #   branches:
  #     - staging

jobs:
  build-and-deploy:
    name: 建構和部署到測試環境
    runs-on: [ubuntu-latest]
    container: 
      image: node:20.15.1-slim  # 修改為 slim 版本
      volumes:
        - ${{ secrets.HOST_DEPLOY_PATH }}:${{ secrets.DEPLOY_PATH }}
    
    env:
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
    
    steps:
      # 檢出程式碼
      - name: 檢出程式碼
        uses: actions/checkout@v4
        
      # 驗證 Node.js 版本
      - name: 驗證 Node.js 和 npm 版本
        run: |
          echo "Node.js 版本: $(node --version)"
          echo "npm 版本: $(npm --version)"
          echo "作業系統: $(cat /etc/os-release | grep PRETTY_NAME)"
          
      # 快取 npm 全域快取
      - name: 快取 npm 全域快取
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: debian-${{ runner.os }}-npm-cache-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            debian-${{ runner.os }}-npm-cache-
            
      # 快取 node_modules（強化版）
      - name: 快取 node_modules
        uses: actions/cache@v3
        id: cache-dependencies
        with:
          path: node_modules
          key: debian-slim-${{ runner.os }}-node-modules-${{ hashFiles('**/package.json', '**/package-lock.json') }}-rollup-fix-v1
          restore-keys: |
            debian-slim-${{ runner.os }}-node-modules-rollup-fix-v1-
            
      # 預處理環境設定
      - name: 預處理環境設定
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: |
          echo "設定環境以解決 rollup native dependencies 問題..."
          
          # 安裝必要的系統套件
          apt-get update && apt-get install -y python3 make g++ || true
          
          # 設定 npm 環境變數
          npm config set target_platform linux
          npm config set target_arch x64
          npm config set target_libc glibc
          npm config set rebuild false
          npm config set build-from-source false
          
          echo "環境設定完成"
          
      # 安裝相依套件（強化版）
      - name: 安裝相依套件
        if: steps.cache-dependencies.outputs.cache-hit != 'true'
        run: |
          echo "快取未命中，執行強化版 npm 安裝..."
          
          # 定義安裝函式
          install_dependencies() {
            local method=$1
            echo "使用方法 $method 安裝相依套件..."
            
            case $method in
              1)
                # 方法1：標準 npm ci
                npm ci --prefer-offline --no-audit --no-fund
                ;;
              2)
                # 方法2：清理後重新生成 lock 檔案
                rm -rf node_modules package-lock.json
                npm install --prefer-offline --no-audit --no-fund
                ;;
              3)
                # 方法3：強制重建並忽略 optional dependencies
                rm -rf node_modules package-lock.json
                npm install --no-optional --prefer-offline --no-audit --no-fund
                ;;
              4)
                # 方法4：完全重置並使用 --force
                rm -rf node_modules package-lock.json ~/.npm
                npm cache clean --force
                npm install --force --prefer-offline --no-audit --no-fund
                ;;
            esac
          }
          
          # 逐一嘗試不同安裝方法
          for attempt in 1 2 3 4; do
            echo "=== 嘗試安裝方法 $attempt ==="
            
            if install_dependencies $attempt; then
              echo "✓ 方法 $attempt 安裝成功"
              break
            else
              echo "✗ 方法 $attempt 失敗，繼續嘗試下一個方法..."
              
              if [ $attempt -eq 4 ]; then
                echo "所有安裝方法都失敗了"
                exit 1
              fi
            fi
          done
          
          echo "安裝完成，node_modules 大小: $(du -sh node_modules | cut -f1)"
          
      # 驗證並修復 rollup
      - name: 驗證並修復 rollup
        run: |
          echo "驗證 rollup 安裝狀態..."
          
          # 檢查 rollup 是否正確安裝
          if [ -d "node_modules/rollup" ]; then
            echo "✓ rollup 核心套件已安裝"
          else
            echo "✗ rollup 核心套件缺失"
            exit 1
          fi
          
          # 檢查 native binaries
          echo "檢查 @rollup native binaries..."
          if [ -d "node_modules/@rollup" ]; then
            echo "✓ @rollup 目錄存在"
            ls -la node_modules/@rollup/
          else
            echo "⚠ @rollup 目錄不存在，嘗試手動安裝..."
            npm install @rollup/rollup-linux-x64-gnu --prefer-offline || true
          fi
          
          # 測試 rollup 功能
          echo "測試 rollup 執行..."
          if npx rollup --version; then
            echo "✓ rollup 可以正常執行"
          else
            echo "⚠ rollup 執行測試失敗，但可能仍可建構"
          fi
          
          # 測試 npm scripts
          echo "檢查 package.json scripts..."
          if npm run build --dry-run 2>/dev/null; then
            echo "✓ build script 語法正確"
          else
            echo "⚠ build script 檢查失敗"
          fi
          
      # 顯示詳細的快取和安裝狀態
      - name: 顯示安裝狀態
        run: |
          if [ "${{ steps.cache-dependencies.outputs.cache-hit }}" = "true" ]; then
            echo "✓ 使用快取的 node_modules"
            echo "快取節省的時間約 2-5 分鐘"
            
            # 即使使用快取也要驗證 rollup
            echo "驗證快取的 rollup..."
            if [ -d "node_modules/@rollup" ]; then
              echo "✓ 快取的 rollup native binaries 完整"
            else
              echo "⚠ 快取的 rollup native binaries 缺失，需要重新安裝"
              npm install @rollup/rollup-linux-x64-gnu --prefer-offline || true
            fi
          else
            echo "✓ 重新安裝相依套件並建立快取"
          fi
          
          echo "最終 node_modules 狀態："
          echo "- 大小: $(du -sh node_modules | cut -f1)"
          echo "- 套件數量: $(ls node_modules | wc -l)"
          echo "- rollup 版本: $(npx rollup --version 2>/dev/null || echo '無法獲取')"
          
          echo "重要套件檢查："
          for pkg in "rollup" "vite" "@rollup/rollup-linux-x64-gnu"; do
            if [ -d "node_modules/$pkg" ] || [ -d "node_modules/@rollup" ]; then
              echo "✓ $pkg"
            else
              echo "✗ $pkg (缺失)"
            fi
          done
          
      # 顯示快取狀態
      - name: 顯示快取狀態
        run: |
          if [ "${{ steps.cache-dependencies.outputs.cache-hit }}" = "true" ]; then
            echo "✓ 使用快取的 node_modules"
            echo "快取節省的時間約 2-5 分鐘"
          else
            echo "✓ 重新安裝相依套件並建立快取"
          fi
          
          echo "目前 node_modules 內容："
          ls -la node_modules | head -10
          
      # 執行 lint 檢查
      # - name: 執行 ESLint 檢查
      #   run: npm run lint
        
      # 建構專案
      - name: 建構專案
        run: npm run build
        
      # 檢查建構結果
      - name: 檢查建構結果
        run: |
          if [ ! -d "dist" ]; then
            echo "錯誤：dist 目錄不存在"
            exit 1
          fi
          
          if [ ! "$(ls -A dist)" ]; then
            echo "錯誤：dist 目錄為空"
            exit 1
          fi
          
          echo "建構成功，dist 目錄內容："
          ls -la dist/
          
      # 備份現有檔案（如果存在）
      - name: 備份現有檔案
        run: |
          BACKUP_DIR="${DEPLOY_PATH}_backup_$(date +%Y%m%d_%H%M%S)"
          if [ -d "$DEPLOY_PATH" ] && [ "$(ls -A $DEPLOY_PATH)" ]; then
            echo "備份現有檔案到 $BACKUP_DIR"
            cp -r "$DEPLOY_PATH" "$BACKUP_DIR"
            echo "備份完成"
            
            # 清理舊備份，只保留最新的3個
            echo "清理舊備份檔案..."
            BACKUP_BASE_DIR=$(dirname "$DEPLOY_PATH")
            BACKUP_PATTERN="$(basename "$DEPLOY_PATH")_backup_*"
            
            # 找到所有備份目錄並按時間排序，刪除超過3個的舊備份
            ls -dt "$BACKUP_BASE_DIR"/$BACKUP_PATTERN 2>/dev/null | tail -n +4 | while read old_backup; do
              if [ -d "$old_backup" ]; then
                echo "刪除舊備份: $old_backup"
                rm -rf "$old_backup"
              fi
            done
            
            echo "備份清理完成，目前保留的備份："
            ls -dt "$BACKUP_BASE_DIR"/$BACKUP_PATTERN 2>/dev/null | head -3
          else
            echo "目標目錄不存在或為空，跳過備份"
          fi
          
      # 建立目標目錄（如果不存在）
      - name: 建立目標目錄
        run: |
          mkdir -p "$DEPLOY_PATH"
          echo "目標目錄已準備就緒: $DEPLOY_PATH"
          
      # 清理目標目錄
      - name: 清理目標目錄
        run: |
          if [ -d "$DEPLOY_PATH" ]; then
            rm -rf "$DEPLOY_PATH"/*
            echo "目標目錄已清理"
          fi
          
      # 部署檔案到測試環境
      - name: 部署檔案到測試環境
        run: |
          echo "開始部署檔案..."
          cp -r dist/* "$DEPLOY_PATH"/
          echo "部署完成"
          
      # 驗證部署結果
      - name: 驗證部署結果
        run: |
          echo "驗證部署結果..."
          if [ ! -d "$DEPLOY_PATH" ]; then
            echo "錯誤：目標目錄不存在"
            exit 1
          fi
          
          if [ ! "$(ls -A $DEPLOY_PATH)" ]; then
            echo "錯誤：目標目錄為空"
            exit 1
          fi
          
          echo "部署驗證成功，目標目錄內容："
          ls -la "$DEPLOY_PATH"/
          
          # 檢查重要檔案是否存在
          if [ -f "$DEPLOY_PATH/index.html" ]; then
            echo "✓ index.html 檔案存在"
          else
            echo "⚠ 警告：index.html 檔案不存在"
          fi
          
      # 設定檔案權限
      - name: 設定檔案權限
        run: |
          echo "設定檔案權限..."
          find "$DEPLOY_PATH" -type f -exec chmod 644 {} \;
          find "$DEPLOY_PATH" -type d -exec chmod 755 {} \;
          echo "權限設定完成"
          
      # 顯示部署摘要
      - name: 顯示部署摘要
        run: |
          echo "===================="
          echo "部署摘要"
          echo "===================="
          echo "專案名稱: sepms-frontend"
          echo "分支: ${{ github.ref_name }}"
          echo "提交: ${{ github.sha }}"
          echo "部署時間: $(date)"
          echo "目標目錄: $DEPLOY_PATH"
          echo "檔案數量: $(find "$DEPLOY_PATH" -type f | wc -l)"
          echo "總大小: $(du -sh "$DEPLOY_PATH" | cut -f1)"
          echo "===================="
